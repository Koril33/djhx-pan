{% extends "dashboard.html" %}
{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/file.css') }}">
{% endblock %}
{% block title %}文件管理{% endblock %}
{% block content %}
<h1>文件管理</h1>

<!-- 面包屑导航 -->
<div class="breadcrumbs" id="breadcrumbs">
    {% set root = {'id': None, 'filename': '根目录'} %}
    <a href="{{ url_for('file.file_page') }}">根目录</a>
    <span class="sep">/</span>
    {% if breadcrumbs %}
        {% for crumb in breadcrumbs %}
            {% if not loop.last %}
                <a href="{{ url_for('file.file_page') }}?parent_id={{ crumb.id }}">{{ crumb.filename }}</a>
                <span class="sep">/</span>
            {% else %}
                <span>{{ crumb.filename }}</span>
            {% endif %}
        {% endfor %}
    {% else %}
        <span>当前目录</span>
    {% endif %}
</div>

<div class="toolbar">

    <button class="btn" id="toggleViewBtn">切换到列表视图</button>

    {% if parent %}
        <a class="btn" href="{{ url_for('file.file_page', parent_id=parent.parent_id) }}">返回上级</a>
    {% endif %}

    <!-- 上传表单 -->
    <div style="display:flex; gap:8px; align-items:center;">
        <label class="btn primary" id="browseUploadBtn">
            上传文件
            <input type="file" id="fileInput" name="file" style="display:none;" multiple>
        </label>

        <!-- 修改：创建目录按钮 -->
        <button class="btn" id="createFolderBtn">创建目录</button>
    </div>
    <button class="btn danger" id="deleteSelectedBtn" style="margin-left:auto;">删除选中</button>
</div>

<!-- 创建目录模态框 -->
<div id="createFolderModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>创建新目录</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="createFolderForm">
                <input type="text" id="folderNameInput" class="input-inline" placeholder="输入目录名称" required>
                <input type="hidden" name="parent_id" value="{{ parent.id if parent else '' }}">
                <div class="modal-actions">
                    <button type="button" class="btn" id="cancelCreateFolder">取消</button>
                    <button type="submit" class="btn primary">创建</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 拖拽上传区域 -->
<div id="uploadDropzone" class="upload-dropzone">
    <div style="flex:1">
        将文件拖到此处以上传，或点击"上传文件"选择。<br>
        支持多文件上传。
    </div>
    <div style="width:200px; max-width:40%;">
        <div class="progress" id="globalProgress" style="display:none;">
            <i id="globalProgressBar" style="width:0%"></i>
        </div>
    </div>
</div>

<!-- 多选隐藏表单（提交 selected ids 到后端） -->
<form id="multiDeleteForm" action="{{ url_for('file.delete_multiple') }}" method="post" style="display:none;">
    <input type="hidden" name="selected_ids" id="selectedIdsInput" value="">
</form>


<div id="fileHeader" class="file-header">
    <div class="col-checkbox"></div>
    <div class="col-name">文件名</div>
    <div class="col-size">大小</div>
    <div class="col-time">修改时间</div>
    <div class="col-actions">操作</div>
</div>

<div id="fileContainer" class="grid-view">
    {% if files %}
        {% for f in files %}
            <div class="file-item-wrapper">
                <div class="file-item" data-id="{{ f.id }}">
                    <div class="select-area">
                        <input type="checkbox" class="select-checkbox" value="{{ f.id }}">
                    </div>

                    <!-- 将图标和文件名放在同一个容器中 -->
                    <div class="file-name-area">
                        {% if f.is_dir %}
                            <div class="icon {{ f.icon_class }}" onclick="openDir({{ f.id }})" title="打开文件夹"></div>
                        {% else %}
                            <div class="icon {{ f.icon_class|lower }}" title="{{ f.icon_class|upper }} {{ f.filename }}"></div>
                        {% endif %}
                        <div class="filename" title="{{ f.filename }}">{{ f.filename }}</div>
                    </div>

                    {% if f.is_dir %}
                        <div> - </div>
                    {% else %}
                        <div class="filesize">{{ f.filesize | format_file_size}}</div>
                    {% endif %}
                    <div class="file-create-datetime">{{ f.create_datetime[:19].replace('T', ' ') }}</div>

                    <div class="actions">
                        {% if not f.is_dir %}
                            <a class="btn" href="{{ url_for('file.download_file', file_id=f.id) }}">下载</a>
                        {% endif %}
                        <form action="{{ url_for('file.delete_file_route', file_id=f.id) }}" method="post" style="display:inline;">
                            <button class="btn danger" type="submit" onclick="return confirm('确认删除？')">删除</button>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="empty-placeholder">此目录为空</div>
    {% endif %}
</div>

<script>
    function openDir(id) {
        location.href = `{{ url_for('file.file_page') }}?parent_id=${id}`;
    }

    /* 视图切换 */
    const toggleBtn = document.getElementById('toggleViewBtn');
    const container = document.getElementById('fileContainer');
    let currentView = localStorage.getItem('viewMode') || 'grid';
    applyView(currentView);
    toggleBtn.addEventListener('click', () => {
        currentView = (currentView === 'grid') ? 'list' : 'grid';
        localStorage.setItem('viewMode', currentView);
        applyView(currentView);
    });
    function applyView(mode) {
        const header = document.getElementById('fileHeader');
        if (mode === 'grid') {
            container.classList.add('grid-view');
            container.classList.remove('list-view');
            toggleBtn.textContent = '切换到列表视图';
            header.style.display = 'none';
        }
        else {
            container.classList.add('list-view');
            container.classList.remove('grid-view');
            toggleBtn.textContent = '切换到图标视图';
            header.style.display = 'grid';
        }
    }

    /* 多选删除逻辑 */
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const multiDeleteForm = document.getElementById('multiDeleteForm');
    const selectedIdsInput = document.getElementById('selectedIdsInput');

    function getSelectedIds() {
        const boxes = document.querySelectorAll('.select-checkbox:checked');
        return Array.from(boxes).map(cb => cb.value);
    }

    deleteSelectedBtn.addEventListener('click', () => {
        const ids = getSelectedIds();
        if (!ids.length) {
            alert('请先选择要删除的项');
            return;
        }
        if (!confirm('确认删除所选项？（删除后不可恢复）')) return;
        selectedIdsInput.value = ids.join(',');
        multiDeleteForm.submit();
    });

    /* 点击图片/文件自动切换选择（小交互） */
    document.querySelectorAll('.file-item').forEach(item => {
        item.addEventListener('click', (e) => {
            // 排除：
            // 1. 如果点击的是链接、按钮或表单
            // 2. 如果点击目标是复选框本身或其父容器 (.select-area)
            if (e.target.tagName === 'A' ||
                e.target.tagName === 'BUTTON' ||
                e.target.closest('form') ||
                e.target.closest('.select-area')) {
                return; // 遇到这些元素，直接跳过自定义的 checkbox 切换逻辑
            }

            // 否则，执行通过点击文件卡片主体来切换复选框的状态
            const checkbox = item.parentElement.querySelector('.select-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        });
    });

    /* 创建目录模态框逻辑 */
    const createFolderBtn = document.getElementById('createFolderBtn');
    const createFolderModal = document.getElementById('createFolderModal');
    const createFolderForm = document.getElementById('createFolderForm');
    const folderNameInput = document.getElementById('folderNameInput');
    const cancelCreateFolder = document.getElementById('cancelCreateFolder');
    const closeModal = document.querySelector('.close');

    // 打开模态框
    createFolderBtn.addEventListener('click', () => {
        createFolderModal.style.display = 'flex';
        folderNameInput.focus();
    });

    // 关闭模态框
    function closeCreateFolderModal() {
        createFolderModal.style.display = 'none';
        createFolderForm.reset();
    }

    closeModal.addEventListener('click', closeCreateFolderModal);
    cancelCreateFolder.addEventListener('click', closeCreateFolderModal);

    // 点击模态框外部关闭
    window.addEventListener('click', (e) => {
        if (e.target === createFolderModal) {
            closeCreateFolderModal();
        }
    });

    // 处理表单提交
    createFolderForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const folderName = folderNameInput.value.trim();
        if (!folderName) {
            alert('请输入目录名称');
            return;
        }

        const parentId = "{{ parent.id if parent else '' }}";

        try {
            const formData = new FormData();
            formData.append('folder_name', folderName);
            formData.append('parent_id', parentId);

            const response = await fetch("{{ url_for('file.create_folder') }}", {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                closeCreateFolderModal();
                location.reload(); // 刷新页面显示新创建的目录
            } else {
                const result = await response.json();
                alert('创建目录失败: ' + (result.error || '未知错误'));
            }
        } catch (error) {
            console.error('创建目录错误:', error);
            alert('创建目录时发生错误');
        }
    });

    /* 文件上传（点击 + 拖拽） */
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseUploadBtn');
    const uploadDropzone = document.getElementById('uploadDropzone');
    const parentId = "{{ parent.id if parent else '' }}";
    const globalProgress = document.getElementById('globalProgress');
    const globalProgressBar = document.getElementById('globalProgressBar');

    browseBtn.addEventListener('click', (e) => {
        // fileInput is hidden; clicking label triggers it
        // nothing else needed
    });

    fileInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (files.length) {
            await uploadFiles(files);
            fileInput.value = '';
        }
    });

    /* 拖拽事件 */
    ['dragenter','dragover'].forEach(ev => {
        uploadDropzone.addEventListener(ev, (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadDropzone.classList.add('dragover');
        });
    });
    ['dragleave','drop'].forEach(ev => {
        uploadDropzone.addEventListener(ev, (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadDropzone.classList.remove('dragover');
        });
    });

    uploadDropzone.addEventListener('drop', async (e) => {
        const dt = e.dataTransfer;
        if (!dt) return;
        const files = dt.files;
        if (files && files.length) {
            await uploadFiles(files);
        }
    });

    /* 上传函数：使用 fetch + FormData */
    async function uploadFiles(fileList) {
        const files = Array.from(fileList);
        // Show global progress
        globalProgress.style.display = 'block';
        globalProgressBar.style.width = '0%';

        let uploaded = 0;

        // sequentially upload to keep server load friendly; you can adapt to parallel if needed
        for (const file of files) {
            const form = new FormData();
            form.append('file', file);
            form.append('parent_id', parentId);

            try {
                // use fetch to POST to upload endpoint
                const resp = await fetch("{{ url_for('file.upload_file') }}", {
                    method: 'POST',
                    body: form,
                });
                // treat any response as success for UI; server will handle validation and redirect
            } catch (err) {
                console.error('上传失败', err);
            }
            uploaded++;
            const pct = Math.round((uploaded / files.length) * 100);
            globalProgressBar.style.width = pct + '%';
        }

        // refresh page after uploads complete to show new files
        location.reload();
    }
</script>
{% endblock %}